{
  "main_message": "*Daily Revenue Performance Report*\n2026-01-10 | P50 targets | Week starts MONDAY\n\n*\ud83c\udfaf Today's Snapshot*\n\u2022 MTD revenue at 58.9% - need $593K to hit target\n\u2022 WTD deal volume strong at 135.8% (153 wins)\n\n*\ud83d\udcca Pacing vs Target*\n\u2022 WTD: $828K of $866K (95.6% \u2191) | 153/112 wins\n\u2022 MTD: $851K of $1.4M (58.9% \u2191) | 165/187 wins\n\n*\ud83d\udea8 Top Constraint*\n\u2022 WON stage slipping $409K\n\n*\u26a0\ufe0f Critical Alerts*\n\u2022 *352 past due deals* worth $899K need immediate attention\n\u2022 *630 at-risk deals* (next 14d) totaling $1.8M\n\u2022 *4876 missed lead windows* ($4.7M revenue impact)\n\n*\ud83d\udca1 Key Insight*\n\u2022 AMER|AM SOURCED driving wins this month - replicate success in other regions\n\n\u2192 Thread below for detailed breakdowns and actions",
  "thread_message": "*\ud83d\udcc9 MTD Biggest Gaps* (ranked by $ impact)\n  1. EMEA|N/A|ALL: $119K gap (at 0.0%) - RENEWAL\n  2. AMER|N/A|ALL: $82K gap (at 0.0%) - RENEWAL\n  3. AMER|N/A|INBOUND: $79K gap (at 0.0%) - MIGRATION\n  4. AMER|SMB|OUTBOUND: $46K gap (at 23.2%) - NEW LOGO\n  5. AMER|SMB|INBOUND: $45K gap (at 20.8%) - INBOUND\n  6. AMER|STRATEGIC|AE SOURCED: $37K gap (at 0.0%) - R360 NEW LOGO\n\n*\ud83d\udcc8 MTD Wins* (learn from success)\n  1. AMER|N/A|AM SOURCED: +$48K (124.1% to target) - EXPANSION\n  2. AMER|N/A|INBOUND: +$47K (161.3% to target) - EXPANSION\n  3. EMEA|SMB|INBOUND: +$37K (373.2% to target) - INBOUND\n\n*\ud83c\udfc6 MTD Top Performers* (celebrate)\n  1. AMER|N/A|AM SOURCED: $250K booked - EXPANSION\n  2. AMER|N/A|INBOUND: $125K booked - EXPANSION\n  3. EMEA|N/A|AM SOURCED: $113K booked - EXPANSION\n  4. EMEA|N/A|AM SOURCED: $74K booked - MIGRATION\n  5. AMER|SMB|AE SOURCED: $69K booked - R360 NEW LOGO\n  6. AMER|N/A|INBOUND: $51K booked - R360 EXPANSION\n\n*\ud83c\udfa3 Inbound MQL WTD Status*\n  1. AMER|SMB: 43/129 (33.2%) - 86 gap\n  2. APAC|SMB: 6/26 (23.0%) - 20 gap\n  3. EMEA|SMB: 8/16 (47.5%) - 8 gap\n  4. APAC|N/A: 0/1 (0.0%) - 1 gap\n  5. AMER|STRATEGIC: 0/0 (N/A) - 0 gap\n  6. EMEA|STRATEGIC: 0/0 (N/A) - 0 gap\n\n*\ud83c\udf0d Region Summary - MTD*\n  \ud83d\udd34 *AMER*: $528K of $922K (57.2%) | 84/108 wins | $394K gap\n  \ud83d\udd34 *EMEA*: $287K of $441K (65.1%) | 72/65 wins | $154K gap\n  \ud83d\udd34 *APAC*: $35K of $80K (44.4%) | 9/13 wins | $44K gap\n\n*\ud83c\udfaf Product Performance - MTD*\n  \ud83d\udd34 *NEW BUSINESS*: $195K of $538K (36.2%) | 21/57 wins | $344K gap\n  \u2713 *EXISTING BUSINESS*: $582K of $450K (129.2%) | 141/111 wins | $-131K gap\n  \ud83d\udd34 *RENEWAL*: $0 of $245K (0.0%) | 0/0 wins | $245K gap\n  \ud83d\udd34 *MIGRATION*: $74K of $210K (35.2%) | 3/19 wins | $136K gap\n\n*\ud83c\udfac Actions Required - Next 48 Hours*\n  1. *[MQL]* Marketing to launch targeted campaign for AMER|SMB (need 86 MQLs) - target 50% gap closure by Friday\n  2. *[SQL]* Sales ops to review SQL pipeline velocity - ensure timely follow-up on qualified leads\n  3. *[SAL]* AE team to maintain SAL\u2192SQO momentum - schedule technical demos for pending SALs\n  4. *[SQO]* Sales leadership to review SQO pipeline health - identify deals needing executive engagement\n  5. *[WON]* Account management to accelerate EMEA|N/A|ALL deals - $119K at risk\n  6. *[RISK]* Sales leadership to review 630 at-risk deals (worth $1.8M) - weekly checkpoints required\n  7. *[PROCESS]* Data team to investigate 99 rows where SAL>SQL - likely data entry issue\n  8. *[OPPORTUNITY]* Replicate AMER|AM SOURCED success playbook to other regions - generated +$48K this month\n\n*\ud83d\udccb Alert Details*\n\u2022 Past due under pacing: 352 deals totaling $899K\n\u2022 Missed lead windows: 4876 opportunities ($4.7M impact)\n\u2022 At-risk (next 14d): 630 deals worth $1.8M\n\n*\ud83d\udd0d Data Quality Notes*\n\u2022 Anomalies (MTD): SAL>SQL 99, SQO>SAL 141, WON>SQO 59\n\u2022 Actual ACV basis: Won_Date\n\u2022 Generated: 2026-01-11 15:13:45.704742+00",
  "report_payload_json": "{\"as_of_date\": \"2026-01-10\", \"percentile\": \"P50\", \"week_starts_on\": \"MONDAY\", \"actuals_date_basis\": \"Won_Date\", \"sum_by_won_date\": 850569.3922311859, \"sum_by_target_date\": 850569.3922311859, \"scorecard_all_sources\": [{\"horizon\": \"WTD\", \"Target_ACV\": 866122.8683610943, \"Actual_ACV\": 827683.6022311861, \"Target_Won\": 112.64516129032174, \"Actual_Won\": 153, \"Revenue_Pacing_Score\": 0.9556191534318402, \"Volume_Pacing_Score\": 1.3582474226804224, \"SQL_to_SAL\": -0.013583350792648885, \"SAL_to_SQO\": 0.19193020719738607, \"SQO_to_Won\": 0.15844155844156016, \"SQL_to_SQO\": 0.05415880997277145, \"Worst_Slippage\": {\"stage\": \"SQL\", \"value\": -56695.666470897064}, \"Prior_Actual_ACV\": 19122.57, \"Prior_Revenue_Pacing\": 0.04415671424583071, \"Revenue_Trend\": \"improving\"}, {\"horizon\": \"MTD\", \"Target_ACV\": 1443538.113935155, \"Actual_ACV\": 850569.3922311859, \"Target_Won\": 187.74193548386896, \"Actual_Won\": 165, \"Revenue_Pacing_Score\": 0.5892254482373814, \"Volume_Pacing_Score\": 0.8788659793814527, \"SQL_to_SAL\": -0.022221753260452837, \"SAL_to_SQO\": 0.2634770889487643, \"SQO_to_Won\": -0.07973157947449938, \"SQL_to_SQO\": 0.06645422698687053, \"Worst_Slippage\": {\"stage\": \"WON\", \"value\": -408660.53745288256}, \"Prior_Actual_ACV\": null, \"Prior_Revenue_Pacing\": null, \"Revenue_Trend\": \"improving\"}, {\"horizon\": \"QTD\", \"Target_ACV\": 1443538.113935155, \"Actual_ACV\": 850569.3922311859, \"Target_Won\": 187.74193548386896, \"Actual_Won\": 165, \"Revenue_Pacing_Score\": 0.5892254482373814, \"Volume_Pacing_Score\": 0.8788659793814527, \"SQL_to_SAL\": -0.022221753260452837, \"SAL_to_SQO\": 0.2634770889487643, \"SQO_to_Won\": -0.07973157947449938, \"SQL_to_SQO\": 0.06645422698687053, \"Worst_Slippage\": {\"stage\": \"WON\", \"value\": -408660.53745288256}, \"Prior_Actual_ACV\": null, \"Prior_Revenue_Pacing\": null, \"Revenue_Trend\": \"improving\"}, {\"horizon\": \"YTD\", \"Target_ACV\": 1443538.113935155, \"Actual_ACV\": 850569.3922311859, \"Target_Won\": 187.74193548386896, \"Actual_Won\": 165, \"Revenue_Pacing_Score\": 0.5892254482373814, \"Volume_Pacing_Score\": 0.8788659793814527, \"SQL_to_SAL\": -0.022221753260452837, \"SAL_to_SQO\": 0.2634770889487643, \"SQO_to_Won\": -0.07973157947449938, \"SQL_to_SQO\": 0.06645422698687053, \"Worst_Slippage\": {\"stage\": \"WON\", \"value\": -408660.53745288256}, \"Prior_Actual_ACV\": null, \"Prior_Revenue_Pacing\": null, \"Revenue_Trend\": \"improving\"}], \"scorecard_inbound\": [{\"horizon\": \"WTD\", \"Target_ACV\": 238361.27526870268, \"Actual_ACV\": 242539.20683544307, \"Target_Won\": 40.06451612903219, \"Actual_Won\": 54, \"Revenue_Pacing_Score\": 1.0175277278661587, \"Volume_Pacing_Score\": 1.347826086956524, \"Prior_Actual_ACV\": 2707.41, \"Prior_Revenue_Pacing\": 0.02271686117594365, \"Revenue_Trend\": \"improving\"}, {\"horizon\": \"MTD\", \"Target_ACV\": 397268.7921145049, \"Actual_ACV\": 245246.61683544307, \"Target_Won\": 66.7741935483869, \"Actual_Won\": 57, \"Revenue_Pacing_Score\": 0.6173316950724776, \"Volume_Pacing_Score\": 0.8536231884057995, \"Prior_Actual_ACV\": null, \"Prior_Revenue_Pacing\": null, \"Revenue_Trend\": \"improving\"}, {\"horizon\": \"QTD\", \"Target_ACV\": 397268.7921145049, \"Actual_ACV\": 245246.61683544307, \"Target_Won\": 66.7741935483869, \"Actual_Won\": 57, \"Revenue_Pacing_Score\": 0.6173316950724776, \"Volume_Pacing_Score\": 0.8536231884057995, \"Prior_Actual_ACV\": null, \"Prior_Revenue_Pacing\": null, \"Revenue_Trend\": \"improving\"}, {\"horizon\": \"YTD\", \"Target_ACV\": 397268.7921145049, \"Actual_ACV\": 245246.61683544307, \"Target_Won\": 66.7741935483869, \"Actual_Won\": 57, \"Revenue_Pacing_Score\": 0.6173316950724776, \"Volume_Pacing_Score\": 0.8536231884057995, \"Prior_Actual_ACV\": null, \"Prior_Revenue_Pacing\": null, \"Revenue_Trend\": \"improving\"}], \"worst_revenue_pacing_by_horizon\": {\"WTD\": [{\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"r\": \"EMEA\", \"seg\": \"N/A\", \"src\": \"INBOUND\", \"Target_ACV\": 205.1566448869162, \"Actual_ACV\": 0, \"Revenue_Pacing\": 0, \"ACV_Gap\": 205.1566448869162}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"r\": \"APAC\", \"seg\": \"N/A\", \"src\": \"INBOUND\", \"Target_ACV\": 167.80345516505105, \"Actual_ACV\": 0, \"Revenue_Pacing\": 0, \"ACV_Gap\": 167.80345516505105}, {\"rt\": \"POR\", \"ot\": \"NEW BUSINESS\", \"r\": \"AMER\", \"seg\": \"SMB\", \"src\": \"AE SOURCED\", \"Target_ACV\": 7227.109402335657, \"Actual_ACV\": 0, \"Revenue_Pacing\": 0, \"ACV_Gap\": 7227.109402335657}, {\"rt\": \"POR\", \"ot\": \"RENEWAL\", \"r\": \"APAC\", \"seg\": \"N/A\", \"src\": \"ALL\", \"Target_ACV\": 9250.41344516129, \"Actual_ACV\": 0, \"Revenue_Pacing\": 0, \"ACV_Gap\": 9250.41344516129}, {\"rt\": \"POR\", \"ot\": \"RENEWAL\", \"r\": \"EMEA\", \"seg\": \"N/A\", \"src\": \"ALL\", \"Target_ACV\": 71569.37427096775, \"Actual_ACV\": 0, \"Revenue_Pacing\": 0, \"ACV_Gap\": 71569.37427096775}], \"MTD\": [{\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"r\": \"EMEA\", \"seg\": \"N/A\", \"src\": \"INBOUND\", \"Target_ACV\": 341.9277414781936, \"Actual_ACV\": 0, \"Revenue_Pacing\": 0, \"ACV_Gap\": 341.9277414781936}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"r\": \"APAC\", \"seg\": \"N/A\", \"src\": \"INBOUND\", \"Target_ACV\": 279.6724252750851, \"Actual_ACV\": 0, \"Revenue_Pacing\": 0, \"ACV_Gap\": 279.6724252750851}, {\"rt\": \"POR\", \"ot\": \"NEW BUSINESS\", \"r\": \"AMER\", \"seg\": \"SMB\", \"src\": \"AE SOURCED\", \"Target_ACV\": 12045.182337226088, \"Actual_ACV\": 0, \"Revenue_Pacing\": 0, \"ACV_Gap\": 12045.182337226088}, {\"rt\": \"POR\", \"ot\": \"RENEWAL\", \"r\": \"APAC\", \"seg\": \"N/A\", \"src\": \"ALL\", \"Target_ACV\": 15417.355741935475, \"Actual_ACV\": 0, \"Revenue_Pacing\": 0, \"ACV_Gap\": 15417.355741935475}, {\"rt\": \"POR\", \"ot\": \"RENEWAL\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"ALL\", \"Target_ACV\": 82032.49999967187, \"Actual_ACV\": 0, \"Revenue_Pacing\": 0, \"ACV_Gap\": 82032.49999967187}], \"QTD\": [{\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"r\": \"EMEA\", \"seg\": \"N/A\", \"src\": \"INBOUND\", \"Target_ACV\": 341.9277414781936, \"Actual_ACV\": 0, \"Revenue_Pacing\": 0, \"ACV_Gap\": 341.9277414781936}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"r\": \"APAC\", \"seg\": \"N/A\", \"src\": \"INBOUND\", \"Target_ACV\": 279.6724252750851, \"Actual_ACV\": 0, \"Revenue_Pacing\": 0, \"ACV_Gap\": 279.6724252750851}, {\"rt\": \"POR\", \"ot\": \"NEW BUSINESS\", \"r\": \"AMER\", \"seg\": \"SMB\", \"src\": \"AE SOURCED\", \"Target_ACV\": 12045.182337226088, \"Actual_ACV\": 0, \"Revenue_Pacing\": 0, \"ACV_Gap\": 12045.182337226088}, {\"rt\": \"POR\", \"ot\": \"RENEWAL\", \"r\": \"APAC\", \"seg\": \"N/A\", \"src\": \"ALL\", \"Target_ACV\": 15417.355741935475, \"Actual_ACV\": 0, \"Revenue_Pacing\": 0, \"ACV_Gap\": 15417.355741935475}, {\"rt\": \"POR\", \"ot\": \"RENEWAL\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"ALL\", \"Target_ACV\": 82032.49999967187, \"Actual_ACV\": 0, \"Revenue_Pacing\": 0, \"ACV_Gap\": 82032.49999967187}], \"YTD\": [{\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"r\": \"EMEA\", \"seg\": \"N/A\", \"src\": \"INBOUND\", \"Target_ACV\": 341.9277414781936, \"Actual_ACV\": 0, \"Revenue_Pacing\": 0, \"ACV_Gap\": 341.9277414781936}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"r\": \"APAC\", \"seg\": \"N/A\", \"src\": \"INBOUND\", \"Target_ACV\": 279.6724252750851, \"Actual_ACV\": 0, \"Revenue_Pacing\": 0, \"ACV_Gap\": 279.6724252750851}, {\"rt\": \"POR\", \"ot\": \"NEW BUSINESS\", \"r\": \"AMER\", \"seg\": \"SMB\", \"src\": \"AE SOURCED\", \"Target_ACV\": 12045.182337226088, \"Actual_ACV\": 0, \"Revenue_Pacing\": 0, \"ACV_Gap\": 12045.182337226088}, {\"rt\": \"POR\", \"ot\": \"RENEWAL\", \"r\": \"APAC\", \"seg\": \"N/A\", \"src\": \"ALL\", \"Target_ACV\": 15417.355741935475, \"Actual_ACV\": 0, \"Revenue_Pacing\": 0, \"ACV_Gap\": 15417.355741935475}, {\"rt\": \"POR\", \"ot\": \"RENEWAL\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"ALL\", \"Target_ACV\": 82032.49999967187, \"Actual_ACV\": 0, \"Revenue_Pacing\": 0, \"ACV_Gap\": 82032.49999967187}]}, \"region_summary_mtd\": [{\"region\": \"AMER\", \"Target_ACV\": 922128.7903222551, \"Actual_ACV\": 527676.99, \"Target_Won\": 108.38709677419295, \"Actual_Won\": 84, \"Revenue_Pacing\": 0.572237843062674, \"Volume_Pacing\": 0.7750000000000042, \"ACV_Gap\": 394451.8003222551}, {\"region\": \"EMEA\", \"Target_ACV\": 441443.5807741937, \"Actual_ACV\": 287400.64223118656, \"Target_Won\": 65.80645161290292, \"Actual_Won\": 72, \"Revenue_Pacing\": 0.651047279308377, \"Volume_Pacing\": 1.0941176470588287, \"ACV_Gap\": 154042.93854300713}, {\"region\": \"APAC\", \"Target_ACV\": 79965.7428387096, \"Actual_ACV\": 35491.76, \"Target_Won\": 13.548387096774274, \"Actual_Won\": 9, \"Revenue_Pacing\": 0.44383705747080543, \"Volume_Pacing\": 0.6642857142857104, \"ACV_Gap\": 44473.9828387096}], \"opportunity_type_summary_mtd\": [{\"opp_type\": \"NEW BUSINESS\", \"Target_ACV\": 538461.2903225786, \"Actual_ACV\": 194809.12784810126, \"Target_Won\": 57.096774193548015, \"Actual_Won\": 21, \"Revenue_Pacing\": 0.361788547012165, \"Volume_Pacing\": 0.36779661016949394, \"ACV_Gap\": 343652.1624744774}, {\"opp_type\": \"EXISTING BUSINESS\", \"Target_ACV\": 450435.48387096793, \"Actual_ACV\": 581804.4922311865, \"Target_Won\": 111.29032258064504, \"Actual_Won\": 141, \"Revenue_Pacing\": 1.291648888829217, \"Volume_Pacing\": 1.2669565217391319, \"ACV_Gap\": -131369.00836021855}, {\"opp_type\": \"RENEWAL\", \"Target_ACV\": 244592.95264483328, \"Actual_ACV\": 0, \"Target_Won\": 0, \"Actual_Won\": 0, \"Revenue_Pacing\": 0, \"Volume_Pacing\": null, \"ACV_Gap\": 244592.95264483328}, {\"opp_type\": \"MIGRATION\", \"Target_ACV\": 210048.3870967743, \"Actual_ACV\": 73955.77215189874, \"Target_Won\": 19.35483870967746, \"Actual_Won\": 3, \"Revenue_Pacing\": 0.3520892170327666, \"Volume_Pacing\": 0.1549999999999997, \"ACV_Gap\": 136092.61494487556}]}",
  "detail_payload_json": "{\"generated_at_utc\": \"2026-01-11 15:13:45.704742+00\", \"as_of_date\": \"2026-01-10\", \"percentile\": \"P50\", \"week_starts_on\": \"MONDAY\", \"actuals_date_basis\": \"Won_Date\", \"top_variance_mtd\": [{\"rt\": \"POR\", \"ot\": \"RENEWAL\", \"ft\": \"RENEWAL\", \"r\": \"EMEA\", \"seg\": \"N/A\", \"src\": \"ALL\", \"t_won\": 0, \"a_won\": 0, \"t_acv\": 119282.29045161292, \"a_acv\": 0, \"acv_var\": -119282.29045161292, \"won_slip\": 0}, {\"rt\": \"POR\", \"ot\": \"RENEWAL\", \"ft\": \"RENEWAL\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"ALL\", \"t_won\": 0, \"a_won\": 0, \"t_acv\": 82032.49999967187, \"a_acv\": 0, \"acv_var\": -82032.49999967187, \"won_slip\": 0}, {\"rt\": \"POR\", \"ot\": \"MIGRATION\", \"ft\": \"MIGRATION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"INBOUND\", \"t_won\": 5.806451612903223, \"a_won\": 0, \"t_acv\": 79288.33847762554, \"a_acv\": 0, \"acv_var\": -79288.33847762554, \"won_slip\": -79288.33847762554}, {\"rt\": \"POR\", \"ot\": \"NEW BUSINESS\", \"ft\": \"NEW LOGO\", \"r\": \"AMER\", \"seg\": \"SMB\", \"src\": \"OUTBOUND\", \"t_won\": 2.9032258064516117, \"a_won\": 3, \"t_acv\": 60486.888277119426, \"a_acv\": 14033.16, \"acv_var\": -46453.72827711942, \"won_slip\": 2016.2296092373144}, {\"rt\": \"POR\", \"ot\": \"NEW BUSINESS\", \"ft\": \"INBOUND\", \"r\": \"AMER\", \"seg\": \"SMB\", \"src\": \"INBOUND\", \"t_won\": 7.741935483870963, \"a_won\": 3, \"t_acv\": 56314.57890588977, \"a_acv\": 11735.28, \"acv_var\": -44579.29890588979, \"won_slip\": -34492.679579857504}, {\"rt\": \"R360\", \"ot\": \"NEW BUSINESS\", \"ft\": \"R360 NEW LOGO\", \"r\": \"AMER\", \"seg\": \"STRATEGIC\", \"src\": \"AE SOURCED\", \"t_won\": 0.9677419354838703, \"a_won\": 0, \"t_acv\": 37161.29032258066, \"a_acv\": 0, \"acv_var\": -37161.29032258066, \"won_slip\": -37161.29032258066}], \"top_positive_mtd\": [{\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"t_won\": 30.96774193548385, \"a_won\": 21, \"t_acv\": 201253.04291070148, \"a_acv\": 249688.5, \"acv_var\": 48435.45708929852, \"won_slip\": -64778.32318688204}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"INBOUND\", \"t_won\": 14.516129032258075, \"a_won\": 15, \"t_acv\": 77456.63450865334, \"a_acv\": 124924.59000000001, \"acv_var\": 47467.95549134666, \"won_slip\": 2581.8878169551163}, {\"rt\": \"POR\", \"ot\": \"NEW BUSINESS\", \"ft\": \"INBOUND\", \"r\": \"EMEA\", \"seg\": \"SMB\", \"src\": \"INBOUND\", \"t_won\": 1.9354838709677407, \"a_won\": 3, \"t_acv\": 13492.233118649348, \"a_acv\": 50355.60759493671, \"acv_var\": 36863.37447628737, \"won_slip\": 7420.728215257144}], \"top_booked_mtd\": [{\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"t_won\": 30.96774193548385, \"a_won\": 21, \"t_acv\": 201253.04291070148, \"a_acv\": 249688.5, \"acv_var\": 48435.45708929852, \"won_slip\": -64778.32318688204}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"INBOUND\", \"t_won\": 14.516129032258075, \"a_won\": 15, \"t_acv\": 77456.63450865334, \"a_acv\": 124924.59000000001, \"acv_var\": 47467.95549134666, \"won_slip\": 2581.8878169551163}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"EMEA\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"t_won\": 41.61290322580647, \"a_won\": 60, \"t_acv\": 97980.65290368306, \"a_acv\": 113199.64223118652, \"acv_var\": 15218.989327503426, \"won_slip\": 43293.776864418105}, {\"rt\": \"POR\", \"ot\": \"MIGRATION\", \"ft\": \"MIGRATION\", \"r\": \"EMEA\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"t_won\": 6.7741935483870925, \"a_won\": 3, \"t_acv\": 85554.42029793163, \"a_acv\": 73955.77215189874, \"acv_var\": -11598.648146032905, \"won_slip\": -47666.03416599049}, {\"rt\": \"R360\", \"ot\": \"NEW BUSINESS\", \"ft\": \"R360 NEW LOGO\", \"r\": \"AMER\", \"seg\": \"SMB\", \"src\": \"AE SOURCED\", \"t_won\": 6.7741935483870925, \"a_won\": 6, \"t_acv\": 57191.01724109833, \"a_acv\": 68795.45999999999, \"acv_var\": 11604.442758901692, \"won_slip\": -6536.116256125526}, {\"rt\": \"R360\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"R360 EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"INBOUND\", \"t_won\": 19.354838709677413, \"a_won\": 33, \"t_acv\": 52516.97788450655, \"a_acv\": 50940, \"acv_var\": -1576.977884506576, \"won_slip\": 37024.46940857714}], \"inbound_mql_wtd\": [{\"r\": \"AMER\", \"seg\": \"SMB\", \"src\": \"INBOUND\", \"a_mql\": 43, \"t_mql\": 129.48387096774186, \"mql_gap\": 86.48387096774186, \"mql_attainment\": 0.33208769307424035}, {\"r\": \"APAC\", \"seg\": \"SMB\", \"src\": \"INBOUND\", \"a_mql\": 6, \"t_mql\": 26.129032258064523, \"mql_gap\": 20.129032258064523, \"mql_attainment\": 0.22962962962962957}, {\"r\": \"EMEA\", \"seg\": \"SMB\", \"src\": \"INBOUND\", \"a_mql\": 8, \"t_mql\": 16.838709677419352, \"mql_gap\": 8.838709677419352, \"mql_attainment\": 0.4750957854406131}, {\"r\": \"APAC\", \"seg\": \"N/A\", \"src\": \"INBOUND\", \"a_mql\": 0, \"t_mql\": 1.1612903225806444, \"mql_gap\": 1.1612903225806444, \"mql_attainment\": 0}, {\"r\": \"AMER\", \"seg\": \"STRATEGIC\", \"src\": \"INBOUND\", \"a_mql\": 0, \"t_mql\": 0, \"mql_gap\": 0, \"mql_attainment\": null}, {\"r\": \"EMEA\", \"seg\": \"STRATEGIC\", \"src\": \"INBOUND\", \"a_mql\": 0, \"t_mql\": 0, \"mql_gap\": 0, \"mql_attainment\": null}], \"alerts\": {\"past_due_under_pacing_count\": 352, \"past_due_under_pacing_sum\": 898864.0746533471, \"past_due_under_pacing_items\": [{\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-04\", \"t_won\": 3.096774193548387, \"a_won\": 0, \"t_acv\": 20125.304291070148, \"a_acv\": 0, \"acv_var\": -20125.304291070148, \"acv_gap\": 20125.304291070148}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-06\", \"t_won\": 3.096774193548387, \"a_won\": 0, \"t_acv\": 20125.304291070148, \"a_acv\": 0, \"acv_var\": -20125.304291070148, \"acv_gap\": 20125.304291070148}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-09\", \"t_won\": 3.096774193548387, \"a_won\": 0, \"t_acv\": 20125.304291070148, \"a_acv\": 0, \"acv_var\": -20125.304291070148, \"acv_gap\": 20125.304291070148}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-01\", \"t_won\": 3.096774193548387, \"a_won\": 0, \"t_acv\": 20125.304291070148, \"a_acv\": 0, \"acv_var\": -20125.304291070148, \"acv_gap\": 20125.304291070148}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-03\", \"t_won\": 3.096774193548387, \"a_won\": 0, \"t_acv\": 20125.304291070148, \"a_acv\": 0, \"acv_var\": -20125.304291070148, \"acv_gap\": 20125.304291070148}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-02\", \"t_won\": 3.096774193548387, \"a_won\": 3, \"t_acv\": 20125.304291070148, \"a_acv\": 2382, \"acv_var\": -17743.304291070148, \"acv_gap\": 17743.304291070148}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-05\", \"t_won\": 3.096774193548387, \"a_won\": 3, \"t_acv\": 20125.304291070148, \"a_acv\": 4637.46, \"acv_var\": -15487.844291070149, \"acv_gap\": 15487.844291070149}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"EMEA\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-03\", \"t_won\": 4.161290322580646, \"a_won\": 0, \"t_acv\": 9798.06529036831, \"a_acv\": 0, \"acv_var\": -9798.06529036831, \"acv_gap\": 9798.06529036831}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"EMEA\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-04\", \"t_won\": 4.161290322580646, \"a_won\": 0, \"t_acv\": 9798.06529036831, \"a_acv\": 0, \"acv_var\": -9798.06529036831, \"acv_gap\": 9798.06529036831}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"EMEA\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-01\", \"t_won\": 4.161290322580646, \"a_won\": 0, \"t_acv\": 9798.06529036831, \"a_acv\": 0, \"acv_var\": -9798.06529036831, \"acv_gap\": 9798.06529036831}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"EMEA\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-02\", \"t_won\": 4.161290322580646, \"a_won\": 0, \"t_acv\": 9798.06529036831, \"a_acv\": 0, \"acv_var\": -9798.06529036831, \"acv_gap\": 9798.06529036831}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"EMEA\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-09\", \"t_won\": 4.161290322580646, \"a_won\": 0, \"t_acv\": 9798.06529036831, \"a_acv\": 0, \"acv_var\": -9798.06529036831, \"acv_gap\": 9798.06529036831}, {\"rt\": \"POR\", \"ot\": \"MIGRATION\", \"ft\": \"MIGRATION\", \"r\": \"EMEA\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-05\", \"t_won\": 0.6774193548387096, \"a_won\": 0, \"t_acv\": 8555.442029793161, \"a_acv\": 0, \"acv_var\": -8555.442029793161, \"acv_gap\": 8555.442029793161}, {\"rt\": \"POR\", \"ot\": \"MIGRATION\", \"ft\": \"MIGRATION\", \"r\": \"EMEA\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-08\", \"t_won\": 0.6774193548387096, \"a_won\": 0, \"t_acv\": 8555.442029793161, \"a_acv\": 0, \"acv_var\": -8555.442029793161, \"acv_gap\": 8555.442029793161}, {\"rt\": \"POR\", \"ot\": \"MIGRATION\", \"ft\": \"MIGRATION\", \"r\": \"EMEA\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-03\", \"t_won\": 0.6774193548387096, \"a_won\": 0, \"t_acv\": 8555.442029793161, \"a_acv\": 0, \"acv_var\": -8555.442029793161, \"acv_gap\": 8555.442029793161}], \"missed_lead_window_count\": 4876, \"missed_lead_window_sum\": 4670392.519313618, \"missed_lead_window_items\": [{\"rt\": \"POR\", \"ot\": \"NEW BUSINESS\", \"r\": \"APAC\", \"seg\": \"STRATEGIC\", \"src\": \"INBOUND\", \"mql_date\": \"2026-10-31\", \"t_mql\": 0, \"a_mql\": 0, \"mql_slip\": 0, \"mql_gap\": 0}, {\"rt\": \"POR\", \"ot\": \"NEW BUSINESS\", \"r\": \"APAC\", \"seg\": \"STRATEGIC\", \"src\": \"INBOUND\", \"mql_date\": \"2026-10-30\", \"t_mql\": 0, \"a_mql\": 0, \"mql_slip\": 0, \"mql_gap\": 0}, {\"rt\": \"POR\", \"ot\": \"NEW BUSINESS\", \"r\": \"APAC\", \"seg\": \"STRATEGIC\", \"src\": \"INBOUND\", \"mql_date\": \"2026-10-29\", \"t_mql\": 0, \"a_mql\": 0, \"mql_slip\": 0, \"mql_gap\": 0}, {\"rt\": \"POR\", \"ot\": \"NEW BUSINESS\", \"r\": \"APAC\", \"seg\": \"STRATEGIC\", \"src\": \"INBOUND\", \"mql_date\": \"2026-10-28\", \"t_mql\": 0, \"a_mql\": 0, \"mql_slip\": 0, \"mql_gap\": 0}, {\"rt\": \"POR\", \"ot\": \"NEW BUSINESS\", \"r\": \"APAC\", \"seg\": \"STRATEGIC\", \"src\": \"INBOUND\", \"mql_date\": \"2026-10-27\", \"t_mql\": 0, \"a_mql\": 0, \"mql_slip\": 0, \"mql_gap\": 0}, {\"rt\": \"POR\", \"ot\": \"NEW BUSINESS\", \"r\": \"APAC\", \"seg\": \"STRATEGIC\", \"src\": \"INBOUND\", \"mql_date\": \"2026-10-26\", \"t_mql\": 0, \"a_mql\": 0, \"mql_slip\": 0, \"mql_gap\": 0}, {\"rt\": \"POR\", \"ot\": \"NEW BUSINESS\", \"r\": \"APAC\", \"seg\": \"STRATEGIC\", \"src\": \"INBOUND\", \"mql_date\": \"2026-10-25\", \"t_mql\": 0, \"a_mql\": 0, \"mql_slip\": 0, \"mql_gap\": 0}, {\"rt\": \"POR\", \"ot\": \"NEW BUSINESS\", \"r\": \"APAC\", \"seg\": \"STRATEGIC\", \"src\": \"INBOUND\", \"mql_date\": \"2026-10-24\", \"t_mql\": 0, \"a_mql\": 0, \"mql_slip\": 0, \"mql_gap\": 0}, {\"rt\": \"POR\", \"ot\": \"NEW BUSINESS\", \"r\": \"APAC\", \"seg\": \"STRATEGIC\", \"src\": \"INBOUND\", \"mql_date\": \"2026-10-23\", \"t_mql\": 0, \"a_mql\": 0, \"mql_slip\": 0, \"mql_gap\": 0}, {\"rt\": \"POR\", \"ot\": \"NEW BUSINESS\", \"r\": \"APAC\", \"seg\": \"STRATEGIC\", \"src\": \"INBOUND\", \"mql_date\": \"2026-10-22\", \"t_mql\": 0, \"a_mql\": 0, \"mql_slip\": 0, \"mql_gap\": 0}, {\"rt\": \"POR\", \"ot\": \"NEW BUSINESS\", \"r\": \"APAC\", \"seg\": \"STRATEGIC\", \"src\": \"INBOUND\", \"mql_date\": \"2026-10-21\", \"t_mql\": 0, \"a_mql\": 0, \"mql_slip\": 0, \"mql_gap\": 0}, {\"rt\": \"POR\", \"ot\": \"NEW BUSINESS\", \"r\": \"APAC\", \"seg\": \"STRATEGIC\", \"src\": \"INBOUND\", \"mql_date\": \"2026-10-20\", \"t_mql\": 0, \"a_mql\": 0, \"mql_slip\": 0, \"mql_gap\": 0}, {\"rt\": \"POR\", \"ot\": \"NEW BUSINESS\", \"r\": \"APAC\", \"seg\": \"STRATEGIC\", \"src\": \"INBOUND\", \"mql_date\": \"2026-10-19\", \"t_mql\": 0, \"a_mql\": 0, \"mql_slip\": 0, \"mql_gap\": 0}, {\"rt\": \"POR\", \"ot\": \"NEW BUSINESS\", \"r\": \"APAC\", \"seg\": \"STRATEGIC\", \"src\": \"INBOUND\", \"mql_date\": \"2026-10-18\", \"t_mql\": 0, \"a_mql\": 0, \"mql_slip\": 0, \"mql_gap\": 0}, {\"rt\": \"POR\", \"ot\": \"NEW BUSINESS\", \"r\": \"APAC\", \"seg\": \"STRATEGIC\", \"src\": \"INBOUND\", \"mql_date\": \"2026-10-17\", \"t_mql\": 0, \"a_mql\": 0, \"mql_slip\": 0, \"mql_gap\": 0}], \"upcoming_won_risk_next_14_days_count\": 630, \"upcoming_won_risk_next_14_days_sum\": 1798054.8387096755, \"upcoming_won_risk_next_14_days_items\": [{\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-11\", \"t_won\": 3.096774193548387, \"a_won\": 0, \"t_acv\": 20125.304291070148, \"a_acv\": 0, \"acv_gap\": 20125.304291070148}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-22\", \"t_won\": 3.096774193548387, \"a_won\": 0, \"t_acv\": 20125.304291070148, \"a_acv\": 0, \"acv_gap\": 20125.304291070148}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-17\", \"t_won\": 3.096774193548387, \"a_won\": 0, \"t_acv\": 20125.304291070148, \"a_acv\": 0, \"acv_gap\": 20125.304291070148}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-24\", \"t_won\": 3.096774193548387, \"a_won\": 0, \"t_acv\": 20125.304291070148, \"a_acv\": 0, \"acv_gap\": 20125.304291070148}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-14\", \"t_won\": 3.096774193548387, \"a_won\": 0, \"t_acv\": 20125.304291070148, \"a_acv\": 0, \"acv_gap\": 20125.304291070148}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-13\", \"t_won\": 3.096774193548387, \"a_won\": 0, \"t_acv\": 20125.304291070148, \"a_acv\": 0, \"acv_gap\": 20125.304291070148}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-10\", \"t_won\": 3.096774193548387, \"a_won\": 0, \"t_acv\": 20125.304291070148, \"a_acv\": 0, \"acv_gap\": 20125.304291070148}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-15\", \"t_won\": 3.096774193548387, \"a_won\": 0, \"t_acv\": 20125.304291070148, \"a_acv\": 0, \"acv_gap\": 20125.304291070148}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-16\", \"t_won\": 3.096774193548387, \"a_won\": 0, \"t_acv\": 20125.304291070148, \"a_acv\": 0, \"acv_gap\": 20125.304291070148}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-12\", \"t_won\": 3.096774193548387, \"a_won\": 0, \"t_acv\": 20125.304291070148, \"a_acv\": 0, \"acv_gap\": 20125.304291070148}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-23\", \"t_won\": 3.096774193548387, \"a_won\": 0, \"t_acv\": 20125.304291070148, \"a_acv\": 0, \"acv_gap\": 20125.304291070148}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-21\", \"t_won\": 3.096774193548387, \"a_won\": 0, \"t_acv\": 20125.304291070148, \"a_acv\": 0, \"acv_gap\": 20125.304291070148}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-20\", \"t_won\": 3.096774193548387, \"a_won\": 0, \"t_acv\": 20125.304291070148, \"a_acv\": 0, \"acv_gap\": 20125.304291070148}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-19\", \"t_won\": 3.096774193548387, \"a_won\": 0, \"t_acv\": 20125.304291070148, \"a_acv\": 0, \"acv_gap\": 20125.304291070148}, {\"rt\": \"POR\", \"ot\": \"EXISTING BUSINESS\", \"ft\": \"EXPANSION\", \"r\": \"AMER\", \"seg\": \"N/A\", \"src\": \"AM SOURCED\", \"won_date\": \"2026-01-18\", \"t_won\": 3.096774193548387, \"a_won\": 0, \"t_acv\": 20125.304291070148, \"a_acv\": 0, \"acv_gap\": 20125.304291070148}]}, \"anomaly_counts\": {\"rows_sal_gt_sql\": 99, \"rows_sqo_gt_sal\": 141, \"rows_won_gt_sqo\": 59}}",
  "query_1_sql": "-- ============================================================================\n-- Query 1: Enhanced Report Payload with Trend Analysis\n-- ============================================================================\n-- Generates WTD/MTD/QTD/YTD scorecards with week-over-week and month-over-month\n-- comparisons for executive-level insights.\n--\n-- Key Improvements from V1:\n-- - Week-over-week pacing comparison\n-- - Month-over-month trend indicators\n-- - Smart date basis detection (Won_Date vs TargetDate)\n-- - Better structured JSON for parsing\n-- ============================================================================\n\nWITH\n  -- Input parameters\n  params AS (\n    SELECT\n      DATE('2026-01-10') AS as_of_date,\n      'P50' AS percentile,\n      'MONDAY' AS week_starts_on\n  ),\n\n  -- Date calculations for current and prior periods\n  dates AS (\n    SELECT\n      p.*,\n      -- Current period dates\n      DATE_TRUNC(p.as_of_date, WEEK(MONDAY)) AS wtd_start,\n      DATE_TRUNC(p.as_of_date, MONTH) AS mtd_start,\n      DATE_TRUNC(p.as_of_date, QUARTER) AS qtd_start,\n      DATE_TRUNC(p.as_of_date, YEAR) AS ytd_start,\n\n      -- Prior week dates (for WoW comparison)\n      DATE_TRUNC(DATE_SUB(p.as_of_date, INTERVAL 7 DAY), WEEK(MONDAY)) AS prior_wtd_start,\n      DATE_SUB(p.as_of_date, INTERVAL 7 DAY) AS prior_wtd_end,\n\n      -- Prior month dates (for MoM comparison)\n      DATE_TRUNC(DATE_SUB(p.as_of_date, INTERVAL 1 MONTH), MONTH) AS prior_mtd_start,\n      DATE_SUB(p.as_of_date, INTERVAL 1 MONTH) AS prior_mtd_end\n    FROM params p\n  ),\n\n  -- Determine correct date basis for actuals (Won_Date vs TargetDate)\n  date_basis_detection AS (\n    SELECT\n      SUM(CASE WHEN Won_Date BETWEEN d.mtd_start AND d.as_of_date THEN Actual_ACV ELSE 0 END) AS sum_by_won_date,\n      SUM(CASE WHEN TargetDate BETWEEN d.mtd_start AND d.as_of_date THEN Actual_ACV ELSE 0 END) AS sum_by_target_date,\n      CASE\n        WHEN SUM(CASE WHEN Won_Date BETWEEN d.mtd_start AND d.as_of_date THEN Actual_ACV ELSE 0 END) > 0\n        THEN 'Won_Date'\n        ELSE 'TargetDate'\n      END AS date_basis\n    FROM `data-analytics-306119.Staging.StrategicOperatingPlan`, dates d\n  ),\n\n  -- Base data with chosen date basis\n  base_data AS (\n    SELECT\n      sop.*,\n      basis.date_basis,\n      CASE\n        WHEN basis.date_basis = 'Won_Date' THEN sop.Won_Date\n        ELSE sop.TargetDate\n      END AS effective_date\n    FROM `data-analytics-306119.Staging.StrategicOperatingPlan` sop\n    CROSS JOIN date_basis_detection basis\n  ),\n\n  -- Current period aggregations (WTD/MTD/QTD/YTD)\n  current_horizon_agg AS (\n    -- WTD All Sources\n    SELECT\n      'WTD' AS horizon,\n      'ALL' AS source_filter,\n      SUM(Target_ACV) AS Target_ACV,\n      SUM(Actual_ACV) AS Actual_ACV,\n      SUM(Target_Won) AS Target_Won,\n      SUM(Actual_Won) AS Actual_Won,\n      SUM(Target_SQL) AS Target_SQL,\n      SUM(Actual_SQL) AS Actual_SQL,\n      SUM(Target_SAL) AS Target_SAL,\n      SUM(Actual_SAL) AS Actual_SAL,\n      SUM(Target_SQO) AS Target_SQO,\n      SUM(Actual_SQO) AS Actual_SQO,\n      COALESCE(SUM(MQL_Revenue_Slippage), 0) AS MQL_Slippage,\n      COALESCE(SUM(SQL_Revenue_Slippage), 0) AS SQL_Slippage,\n      COALESCE(SUM(SQO_Revenue_Slippage), 0) AS SQO_Slippage,\n      COALESCE(SUM(Won_Count_Revenue_Slippage), 0) AS WON_Slippage\n    FROM base_data, dates\n    WHERE effective_date BETWEEN dates.wtd_start AND dates.as_of_date\n\n    UNION ALL\n\n    -- MTD All Sources\n    SELECT\n      'MTD' AS horizon,\n      'ALL' AS source_filter,\n      SUM(Target_ACV) AS Target_ACV,\n      SUM(Actual_ACV) AS Actual_ACV,\n      SUM(Target_Won) AS Target_Won,\n      SUM(Actual_Won) AS Actual_Won,\n      SUM(Target_SQL) AS Target_SQL,\n      SUM(Actual_SQL) AS Actual_SQL,\n      SUM(Target_SAL) AS Target_SAL,\n      SUM(Actual_SAL) AS Actual_SAL,\n      SUM(Target_SQO) AS Target_SQO,\n      SUM(Actual_SQO) AS Actual_SQO,\n      COALESCE(SUM(MQL_Revenue_Slippage), 0) AS MQL_Slippage,\n      COALESCE(SUM(SQL_Revenue_Slippage), 0) AS SQL_Slippage,\n      COALESCE(SUM(SQO_Revenue_Slippage), 0) AS SQO_Slippage,\n      COALESCE(SUM(Won_Count_Revenue_Slippage), 0) AS WON_Slippage\n    FROM base_data, dates\n    WHERE effective_date BETWEEN dates.mtd_start AND dates.as_of_date\n\n    UNION ALL\n\n    -- QTD All Sources\n    SELECT\n      'QTD' AS horizon,\n      'ALL' AS source_filter,\n      SUM(Target_ACV) AS Target_ACV,\n      SUM(Actual_ACV) AS Actual_ACV,\n      SUM(Target_Won) AS Target_Won,\n      SUM(Actual_Won) AS Actual_Won,\n      SUM(Target_SQL) AS Target_SQL,\n      SUM(Actual_SQL) AS Actual_SQL,\n      SUM(Target_SAL) AS Target_SAL,\n      SUM(Actual_SAL) AS Actual_SAL,\n      SUM(Target_SQO) AS Target_SQO,\n      SUM(Actual_SQO) AS Actual_SQO,\n      COALESCE(SUM(MQL_Revenue_Slippage), 0) AS MQL_Slippage,\n      COALESCE(SUM(SQL_Revenue_Slippage), 0) AS SQL_Slippage,\n      COALESCE(SUM(SQO_Revenue_Slippage), 0) AS SQO_Slippage,\n      COALESCE(SUM(Won_Count_Revenue_Slippage), 0) AS WON_Slippage\n    FROM base_data, dates\n    WHERE effective_date BETWEEN dates.qtd_start AND dates.as_of_date\n\n    UNION ALL\n\n    -- YTD All Sources\n    SELECT\n      'YTD' AS horizon,\n      'ALL' AS source_filter,\n      SUM(Target_ACV) AS Target_ACV,\n      SUM(Actual_ACV) AS Actual_ACV,\n      SUM(Target_Won) AS Target_Won,\n      SUM(Actual_Won) AS Actual_Won,\n      SUM(Target_SQL) AS Target_SQL,\n      SUM(Actual_SQL) AS Actual_SQL,\n      SUM(Target_SAL) AS Target_SAL,\n      SUM(Actual_SAL) AS Actual_SAL,\n      SUM(Target_SQO) AS Target_SQO,\n      SUM(Actual_SQO) AS Actual_SQO,\n      COALESCE(SUM(MQL_Revenue_Slippage), 0) AS MQL_Slippage,\n      COALESCE(SUM(SQL_Revenue_Slippage), 0) AS SQL_Slippage,\n      COALESCE(SUM(SQO_Revenue_Slippage), 0) AS SQO_Slippage,\n      COALESCE(SUM(Won_Count_Revenue_Slippage), 0) AS WON_Slippage\n    FROM base_data, dates\n    WHERE effective_date BETWEEN dates.ytd_start AND dates.as_of_date\n\n    UNION ALL\n\n    -- WTD Inbound Only\n    SELECT\n      'WTD' AS horizon,\n      'INBOUND' AS source_filter,\n      SUM(Target_ACV) AS Target_ACV,\n      SUM(Actual_ACV) AS Actual_ACV,\n      SUM(Target_Won) AS Target_Won,\n      SUM(Actual_Won) AS Actual_Won,\n      SUM(Target_SQL) AS Target_SQL,\n      SUM(Actual_SQL) AS Actual_SQL,\n      SUM(Target_SAL) AS Target_SAL,\n      SUM(Actual_SAL) AS Actual_SAL,\n      SUM(Target_SQO) AS Target_SQO,\n      SUM(Actual_SQO) AS Actual_SQO,\n      0 AS MQL_Slippage,\n      0 AS SQL_Slippage,\n      0 AS SQO_Slippage,\n      0 AS WON_Slippage\n    FROM base_data, dates\n    WHERE effective_date BETWEEN dates.wtd_start AND dates.as_of_date\n      AND Source = 'INBOUND'\n\n    UNION ALL\n\n    -- MTD Inbound Only\n    SELECT\n      'MTD' AS horizon,\n      'INBOUND' AS source_filter,\n      SUM(Target_ACV) AS Target_ACV,\n      SUM(Actual_ACV) AS Actual_ACV,\n      SUM(Target_Won) AS Target_Won,\n      SUM(Actual_Won) AS Actual_Won,\n      SUM(Target_SQL) AS Target_SQL,\n      SUM(Actual_SQL) AS Actual_SQL,\n      SUM(Target_SAL) AS Target_SAL,\n      SUM(Actual_SAL) AS Actual_SAL,\n      SUM(Target_SQO) AS Target_SQO,\n      SUM(Actual_SQO) AS Actual_SQO,\n      0 AS MQL_Slippage,\n      0 AS SQL_Slippage,\n      0 AS SQO_Slippage,\n      0 AS WON_Slippage\n    FROM base_data, dates\n    WHERE effective_date BETWEEN dates.mtd_start AND dates.as_of_date\n      AND Source = 'INBOUND'\n\n    UNION ALL\n\n    -- QTD Inbound Only\n    SELECT\n      'QTD' AS horizon,\n      'INBOUND' AS source_filter,\n      SUM(Target_ACV) AS Target_ACV,\n      SUM(Actual_ACV) AS Actual_ACV,\n      SUM(Target_Won) AS Target_Won,\n      SUM(Actual_Won) AS Actual_Won,\n      SUM(Target_SQL) AS Target_SQL,\n      SUM(Actual_SQL) AS Actual_SQL,\n      SUM(Target_SAL) AS Target_SAL,\n      SUM(Actual_SAL) AS Actual_SAL,\n      SUM(Target_SQO) AS Target_SQO,\n      SUM(Actual_SQO) AS Actual_SQO,\n      0 AS MQL_Slippage,\n      0 AS SQL_Slippage,\n      0 AS SQO_Slippage,\n      0 AS WON_Slippage\n    FROM base_data, dates\n    WHERE effective_date BETWEEN dates.qtd_start AND dates.as_of_date\n      AND Source = 'INBOUND'\n\n    UNION ALL\n\n    -- YTD Inbound Only\n    SELECT\n      'YTD' AS horizon,\n      'INBOUND' AS source_filter,\n      SUM(Target_ACV) AS Target_ACV,\n      SUM(Actual_ACV) AS Actual_ACV,\n      SUM(Target_Won) AS Target_Won,\n      SUM(Actual_Won) AS Actual_Won,\n      SUM(Target_SQL) AS Target_SQL,\n      SUM(Actual_SQL) AS Actual_SQL,\n      SUM(Target_SAL) AS Target_SAL,\n      SUM(Actual_SAL) AS Actual_SAL,\n      SUM(Target_SQO) AS Target_SQO,\n      SUM(Actual_SQO) AS Actual_SQO,\n      0 AS MQL_Slippage,\n      0 AS SQL_Slippage,\n      0 AS SQO_Slippage,\n      0 AS WON_Slippage\n    FROM base_data, dates\n    WHERE effective_date BETWEEN dates.ytd_start AND dates.as_of_date\n      AND Source = 'INBOUND'\n  ),\n\n  -- Prior period aggregations for trend comparison\n  prior_period_agg AS (\n    -- Prior WTD All Sources\n    SELECT\n      'WTD' AS horizon,\n      'ALL' AS source_filter,\n      SUM(Actual_ACV) AS Prior_Actual_ACV,\n      SUM(Actual_Won) AS Prior_Actual_Won,\n      SAFE_DIVIDE(SUM(Actual_ACV), SUM(Target_ACV)) AS Prior_Revenue_Pacing\n    FROM base_data, dates\n    WHERE effective_date BETWEEN dates.prior_wtd_start AND dates.prior_wtd_end\n\n    UNION ALL\n\n    -- Prior MTD All Sources\n    SELECT\n      'MTD' AS horizon,\n      'ALL' AS source_filter,\n      SUM(Actual_ACV) AS Prior_Actual_ACV,\n      SUM(Actual_Won) AS Prior_Actual_Won,\n      SAFE_DIVIDE(SUM(Actual_ACV), SUM(Target_ACV)) AS Prior_Revenue_Pacing\n    FROM base_data, dates\n    WHERE effective_date BETWEEN dates.prior_mtd_start AND dates.prior_mtd_end\n\n    UNION ALL\n\n    -- Prior WTD Inbound\n    SELECT\n      'WTD' AS horizon,\n      'INBOUND' AS source_filter,\n      SUM(Actual_ACV) AS Prior_Actual_ACV,\n      SUM(Actual_Won) AS Prior_Actual_Won,\n      SAFE_DIVIDE(SUM(Actual_ACV), SUM(Target_ACV)) AS Prior_Revenue_Pacing\n    FROM base_data, dates\n    WHERE effective_date BETWEEN dates.prior_wtd_start AND dates.prior_wtd_end\n      AND Source = 'INBOUND'\n\n    UNION ALL\n\n    -- Prior MTD Inbound\n    SELECT\n      'MTD' AS horizon,\n      'INBOUND' AS source_filter,\n      SUM(Actual_ACV) AS Prior_Actual_ACV,\n      SUM(Actual_Won) AS Prior_Actual_Won,\n      SAFE_DIVIDE(SUM(Actual_ACV), SUM(Target_ACV)) AS Prior_Revenue_Pacing\n    FROM base_data, dates\n    WHERE effective_date BETWEEN dates.prior_mtd_start AND dates.prior_mtd_end\n      AND Source = 'INBOUND'\n  ),\n\n  -- Calculate scores with trend indicators\n  scorecard_with_trends AS (\n    SELECT\n      c.horizon,\n      c.source_filter,\n      c.Target_ACV,\n      c.Actual_ACV,\n      c.Target_Won,\n      c.Actual_Won,\n      SAFE_DIVIDE(c.Actual_ACV, c.Target_ACV) AS Revenue_Pacing_Score,\n      SAFE_DIVIDE(c.Actual_Won, c.Target_Won) AS Volume_Pacing_Score,\n\n      -- Conversion rate changes\n      SAFE_DIVIDE(c.Actual_SAL, c.Actual_SQL) - SAFE_DIVIDE(c.Target_SAL, c.Target_SQL) AS SQL_to_SAL,\n      SAFE_DIVIDE(c.Actual_SQO, c.Actual_SAL) - SAFE_DIVIDE(c.Target_SQO, c.Target_SAL) AS SAL_to_SQO,\n      SAFE_DIVIDE(c.Actual_Won, c.Actual_SQO) - SAFE_DIVIDE(c.Target_Won, c.Target_SQO) AS SQO_to_Won,\n      SAFE_DIVIDE(c.Actual_SQO, c.Actual_SQL) - SAFE_DIVIDE(c.Target_SQO, c.Target_SQL) AS SQL_to_SQO,\n\n      -- Worst slippage\n      CASE\n        WHEN c.MQL_Slippage <= LEAST(c.SQL_Slippage, c.SQO_Slippage, c.WON_Slippage) THEN 'MQL'\n        WHEN c.SQL_Slippage <= LEAST(c.SQO_Slippage, c.WON_Slippage) THEN 'SQL'\n        WHEN c.SQO_Slippage <= c.WON_Slippage THEN 'SQO'\n        ELSE 'WON'\n      END AS Worst_Slippage_Stage,\n      LEAST(c.MQL_Slippage, c.SQL_Slippage, c.SQO_Slippage, c.WON_Slippage) AS Worst_Slippage_Value,\n\n      -- Prior period comparison\n      p.Prior_Actual_ACV,\n      p.Prior_Actual_Won,\n      p.Prior_Revenue_Pacing,\n\n      -- Trend indicators\n      CASE\n        WHEN SAFE_DIVIDE(c.Actual_ACV, c.Target_ACV) > COALESCE(p.Prior_Revenue_Pacing, 0) THEN 'improving'\n        WHEN SAFE_DIVIDE(c.Actual_ACV, c.Target_ACV) < COALESCE(p.Prior_Revenue_Pacing, 0) THEN 'worsening'\n        ELSE 'stable'\n      END AS Revenue_Trend\n    FROM current_horizon_agg c\n    LEFT JOIN prior_period_agg p\n      ON c.horizon = p.horizon\n      AND c.source_filter = p.source_filter\n  ),\n\n  -- Worst pacing pockets by horizon\n  pocket_pacing_raw AS (\n    -- WTD\n    SELECT\n      'WTD' AS horizon,\n      RecordType AS rt,\n      OpportunityType AS ot,\n      Region AS r,\n      Segment AS seg,\n      Source AS src,\n      SUM(Target_ACV) AS sum_target,\n      SUM(Actual_ACV) AS sum_actual\n    FROM base_data, dates\n    WHERE effective_date BETWEEN dates.wtd_start AND dates.as_of_date\n    GROUP BY RecordType, OpportunityType, Region, Segment, Source\n\n    UNION ALL\n\n    -- MTD\n    SELECT\n      'MTD' AS horizon,\n      RecordType AS rt,\n      OpportunityType AS ot,\n      Region AS r,\n      Segment AS seg,\n      Source AS src,\n      SUM(Target_ACV) AS sum_target,\n      SUM(Actual_ACV) AS sum_actual\n    FROM base_data, dates\n    WHERE effective_date BETWEEN dates.mtd_start AND dates.as_of_date\n    GROUP BY RecordType, OpportunityType, Region, Segment, Source\n\n    UNION ALL\n\n    -- QTD\n    SELECT\n      'QTD' AS horizon,\n      RecordType AS rt,\n      OpportunityType AS ot,\n      Region AS r,\n      Segment AS seg,\n      Source AS src,\n      SUM(Target_ACV) AS sum_target,\n      SUM(Actual_ACV) AS sum_actual\n    FROM base_data, dates\n    WHERE effective_date BETWEEN dates.qtd_start AND dates.as_of_date\n    GROUP BY RecordType, OpportunityType, Region, Segment, Source\n\n    UNION ALL\n\n    -- YTD\n    SELECT\n      'YTD' AS horizon,\n      RecordType AS rt,\n      OpportunityType AS ot,\n      Region AS r,\n      Segment AS seg,\n      Source AS src,\n      SUM(Target_ACV) AS sum_target,\n      SUM(Actual_ACV) AS sum_actual\n    FROM base_data, dates\n    WHERE effective_date BETWEEN dates.ytd_start AND dates.as_of_date\n    GROUP BY RecordType, OpportunityType, Region, Segment, Source\n  ),\n\n  pocket_pacing AS (\n    SELECT\n      horizon,\n      rt,\n      ot,\n      r,\n      seg,\n      src,\n      sum_target AS Target_ACV,\n      sum_actual AS Actual_ACV,\n      SAFE_DIVIDE(sum_actual, sum_target) AS Revenue_Pacing,\n      (sum_target - sum_actual) AS ACV_Gap\n    FROM pocket_pacing_raw\n    WHERE sum_target > 0\n    QUALIFY ROW_NUMBER() OVER (PARTITION BY horizon ORDER BY SAFE_DIVIDE(sum_actual, sum_target) ASC) <= 5\n  ),\n\n  -- Region Summary (MTD)\n  region_summary_raw AS (\n    SELECT\n      Region AS region,\n      SUM(Target_ACV) AS Target_ACV,\n      SUM(Actual_ACV) AS Actual_ACV,\n      SUM(Target_Won) AS Target_Won,\n      SUM(Actual_Won) AS Actual_Won,\n      SAFE_DIVIDE(SUM(Actual_ACV), SUM(Target_ACV)) AS Revenue_Pacing,\n      SAFE_DIVIDE(SUM(Actual_Won), SUM(Target_Won)) AS Volume_Pacing,\n      (SUM(Target_ACV) - SUM(Actual_ACV)) AS ACV_Gap\n    FROM base_data, dates\n    WHERE effective_date BETWEEN dates.mtd_start AND dates.as_of_date\n    GROUP BY Region\n  ),\n\n  -- OpportunityType Summary (MTD)\n  opportunity_type_summary_raw AS (\n    SELECT\n      OpportunityType AS opp_type,\n      SUM(Target_ACV) AS Target_ACV,\n      SUM(Actual_ACV) AS Actual_ACV,\n      SUM(Target_Won) AS Target_Won,\n      SUM(Actual_Won) AS Actual_Won,\n      SAFE_DIVIDE(SUM(Actual_ACV), SUM(Target_ACV)) AS Revenue_Pacing,\n      SAFE_DIVIDE(SUM(Actual_Won), SUM(Target_Won)) AS Volume_Pacing,\n      (SUM(Target_ACV) - SUM(Actual_ACV)) AS ACV_Gap\n    FROM base_data, dates\n    WHERE effective_date BETWEEN dates.mtd_start AND dates.as_of_date\n    GROUP BY OpportunityType\n  )\n\n-- Build final JSON\nSELECT\n  TO_JSON_STRING(STRUCT(\n    d.as_of_date,\n    d.percentile,\n    d.week_starts_on,\n    basis.date_basis AS actuals_date_basis,\n    basis.sum_by_won_date,\n    basis.sum_by_target_date,\n\n    -- All sources scorecard with trends\n    ARRAY(\n      SELECT AS STRUCT\n        horizon,\n        Target_ACV,\n        Actual_ACV,\n        Target_Won,\n        Actual_Won,\n        Revenue_Pacing_Score,\n        Volume_Pacing_Score,\n        SQL_to_SAL,\n        SAL_to_SQO,\n        SQO_to_Won,\n        SQL_to_SQO,\n        STRUCT(Worst_Slippage_Stage AS stage, Worst_Slippage_Value AS value) AS Worst_Slippage,\n        Prior_Actual_ACV,\n        Prior_Revenue_Pacing,\n        Revenue_Trend\n      FROM scorecard_with_trends\n      WHERE source_filter = 'ALL'\n      ORDER BY CASE horizon WHEN 'WTD' THEN 1 WHEN 'MTD' THEN 2 WHEN 'QTD' THEN 3 WHEN 'YTD' THEN 4 END\n    ) AS scorecard_all_sources,\n\n    -- Inbound scorecard with trends\n    ARRAY(\n      SELECT AS STRUCT\n        horizon,\n        Target_ACV,\n        Actual_ACV,\n        Target_Won,\n        Actual_Won,\n        Revenue_Pacing_Score,\n        Volume_Pacing_Score,\n        Prior_Actual_ACV,\n        Prior_Revenue_Pacing,\n        Revenue_Trend\n      FROM scorecard_with_trends\n      WHERE source_filter = 'INBOUND'\n      ORDER BY CASE horizon WHEN 'WTD' THEN 1 WHEN 'MTD' THEN 2 WHEN 'QTD' THEN 3 WHEN 'YTD' THEN 4 END\n    ) AS scorecard_inbound,\n\n    -- Worst pacing pockets by horizon\n    STRUCT(\n      ARRAY(SELECT AS STRUCT rt, ot, r, seg, src, Target_ACV, Actual_ACV, Revenue_Pacing, ACV_Gap FROM pocket_pacing WHERE horizon = 'WTD' ORDER BY Revenue_Pacing) AS WTD,\n      ARRAY(SELECT AS STRUCT rt, ot, r, seg, src, Target_ACV, Actual_ACV, Revenue_Pacing, ACV_Gap FROM pocket_pacing WHERE horizon = 'MTD' ORDER BY Revenue_Pacing) AS MTD,\n      ARRAY(SELECT AS STRUCT rt, ot, r, seg, src, Target_ACV, Actual_ACV, Revenue_Pacing, ACV_Gap FROM pocket_pacing WHERE horizon = 'QTD' ORDER BY Revenue_Pacing) AS QTD,\n      ARRAY(SELECT AS STRUCT rt, ot, r, seg, src, Target_ACV, Actual_ACV, Revenue_Pacing, ACV_Gap FROM pocket_pacing WHERE horizon = 'YTD' ORDER BY Revenue_Pacing) AS YTD\n    ) AS worst_revenue_pacing_by_horizon,\n\n    -- Region Summary (MTD)\n    ARRAY(\n      SELECT AS STRUCT\n        region,\n        Target_ACV,\n        Actual_ACV,\n        Target_Won,\n        Actual_Won,\n        Revenue_Pacing,\n        Volume_Pacing,\n        ACV_Gap\n      FROM region_summary_raw\n      ORDER BY Target_ACV DESC\n    ) AS region_summary_mtd,\n\n    -- OpportunityType Summary (MTD)\n    ARRAY(\n      SELECT AS STRUCT\n        opp_type,\n        Target_ACV,\n        Actual_ACV,\n        Target_Won,\n        Actual_Won,\n        Revenue_Pacing,\n        Volume_Pacing,\n        ACV_Gap\n      FROM opportunity_type_summary_raw\n      ORDER BY Target_ACV DESC\n    ) AS opportunity_type_summary_mtd\n  )) AS report_payload_json\nFROM dates d\nCROSS JOIN date_basis_detection basis\n",
  "query_2_sql": "-- ============================================================================\n-- Query 2: Enhanced Detail Payload with $ Sums and Trend Indicators\n-- ============================================================================\n-- Generates detailed breakdowns with:\n-- - Top variance drivers (MTD worst 6)\n-- - Top positive variance (MTD best 3)\n-- - Top booked deals (MTD highest 6)\n-- - Inbound MQL gaps (WTD top 6)\n-- - Alert details with $ sums (not just counts)\n-- - Anomaly detection\n--\n-- Key Improvements from V1:\n-- - $ sums for all alert categories\n-- - Trend indicators for gaps\n-- - Better structured for actionable insights\n-- ============================================================================\n\nWITH\n  -- Input parameters\n  params AS (\n    SELECT\n      DATE('2026-01-10') AS as_of_date,\n      'P50' AS percentile,\n      'MONDAY' AS week_starts_on\n  ),\n\n  -- Date calculations\n  dates AS (\n    SELECT\n      p.*,\n      DATE_TRUNC(p.as_of_date, WEEK(MONDAY)) AS wtd_start,\n      DATE_TRUNC(p.as_of_date, MONTH) AS mtd_start,\n      p.as_of_date + 14 AS upcoming_risk_end\n    FROM params p\n  ),\n\n  -- Determine correct date basis for actuals\n  actuals_date_basis_calc AS (\n    SELECT\n      SUM(CASE WHEN Won_Date BETWEEN d.mtd_start AND d.as_of_date THEN Actual_ACV ELSE 0 END) AS sum_by_won_date,\n      SUM(CASE WHEN TargetDate BETWEEN d.mtd_start AND d.as_of_date THEN Actual_ACV ELSE 0 END) AS sum_by_target_date,\n      CASE\n        WHEN SUM(CASE WHEN Won_Date BETWEEN d.mtd_start AND d.as_of_date THEN Actual_ACV ELSE 0 END) > 0 THEN 'Won_Date'\n        ELSE 'TargetDate'\n      END AS chosen_date_basis\n    FROM `data-analytics-306119.Staging.StrategicOperatingPlan`, dates d\n  ),\n\n  -- Base data with chosen date basis\n  base_with_basis AS (\n    SELECT\n      sop.*,\n      basis.chosen_date_basis,\n      CASE\n        WHEN basis.chosen_date_basis = 'Won_Date' THEN sop.Won_Date\n        ELSE sop.TargetDate\n      END AS date_basis\n    FROM `data-analytics-306119.Staging.StrategicOperatingPlan` sop\n    CROSS JOIN actuals_date_basis_calc basis\n  ),\n\n  -- MTD variance drivers (top 6 worst by ACV gap)\n  top_variance_mtd AS (\n    SELECT\n      RecordType AS rt,\n      OpportunityType AS ot,\n      FunnelType AS ft,\n      Region AS r,\n      Segment AS seg,\n      Source AS src,\n      SUM(Target_Won) AS t_won,\n      SUM(Actual_Won) AS a_won,\n      SUM(Target_ACV) AS t_acv,\n      SUM(Actual_ACV) AS a_acv,\n      SUM(ACV_Variance) AS acv_var,\n      SUM(COALESCE(Won_Count_Revenue_Slippage, 0)) AS won_slip\n    FROM base_with_basis, dates\n    WHERE date_basis BETWEEN dates.mtd_start AND dates.as_of_date\n    GROUP BY RecordType, OpportunityType, FunnelType, Region, Segment, Source\n    QUALIFY ROW_NUMBER() OVER (ORDER BY SUM(ACV_Variance) ASC) <= 6\n  ),\n\n  -- MTD positive variance (top 3 best wins)\n  top_positive_mtd AS (\n    SELECT\n      RecordType AS rt,\n      OpportunityType AS ot,\n      FunnelType AS ft,\n      Region AS r,\n      Segment AS seg,\n      Source AS src,\n      SUM(Target_Won) AS t_won,\n      SUM(Actual_Won) AS a_won,\n      SUM(Target_ACV) AS t_acv,\n      SUM(Actual_ACV) AS a_acv,\n      SUM(ACV_Variance) AS acv_var,\n      SUM(COALESCE(Won_Count_Revenue_Slippage, 0)) AS won_slip\n    FROM base_with_basis, dates\n    WHERE date_basis BETWEEN dates.mtd_start AND dates.as_of_date\n    GROUP BY RecordType, OpportunityType, FunnelType, Region, Segment, Source\n    QUALIFY ROW_NUMBER() OVER (ORDER BY SUM(ACV_Variance) DESC) <= 3\n  ),\n\n  -- MTD top booked deals (top 6 by highest actual ACV)\n  top_booked_mtd AS (\n    SELECT\n      RecordType AS rt,\n      OpportunityType AS ot,\n      FunnelType AS ft,\n      Region AS r,\n      Segment AS seg,\n      Source AS src,\n      SUM(Target_Won) AS t_won,\n      SUM(Actual_Won) AS a_won,\n      SUM(Target_ACV) AS t_acv,\n      SUM(Actual_ACV) AS a_acv,\n      SUM(ACV_Variance) AS acv_var,\n      SUM(COALESCE(Won_Count_Revenue_Slippage, 0)) AS won_slip\n    FROM base_with_basis, dates\n    WHERE date_basis BETWEEN dates.mtd_start AND dates.as_of_date\n    GROUP BY RecordType, OpportunityType, FunnelType, Region, Segment, Source\n    QUALIFY ROW_NUMBER() OVER (ORDER BY SUM(Actual_ACV) DESC) <= 6\n  ),\n\n  -- Inbound MQL WTD gaps (top 6 by largest gap)\n  inbound_mql_wtd AS (\n    SELECT\n      Region AS r,\n      Segment AS seg,\n      Source AS src,\n      SUM(Actual_MQL) AS a_mql,\n      SUM(Target_MQL) AS t_mql,\n      (SUM(Target_MQL) - SUM(Actual_MQL)) AS mql_gap,\n      SAFE_DIVIDE(SUM(Actual_MQL), SUM(Target_MQL)) AS mql_attainment\n    FROM `data-analytics-306119.Staging.StrategicOperatingPlan`, dates\n    WHERE TargetDate BETWEEN dates.wtd_start AND dates.as_of_date\n      AND Source = 'INBOUND'\n    GROUP BY Region, Segment, Source\n    QUALIFY ROW_NUMBER() OVER (ORDER BY (SUM(Target_MQL) - SUM(Actual_MQL)) DESC) <= 6\n  ),\n\n  -- Alert 1: Past due deals under pacing\n  past_due_under_pacing AS (\n    SELECT\n      RecordType AS rt,\n      OpportunityType AS ot,\n      FunnelType AS ft,\n      Region AS r,\n      Segment AS seg,\n      Source AS src,\n      Won_Date AS won_date,\n      SUM(Target_Won) AS t_won,\n      SUM(Actual_Won) AS a_won,\n      SUM(Target_ACV) AS t_acv,\n      SUM(Actual_ACV) AS a_acv,\n      SUM(ACV_Variance) AS acv_var,\n      (SUM(Target_ACV) - SUM(Actual_ACV)) AS acv_gap\n    FROM `data-analytics-306119.Staging.StrategicOperatingPlan`, dates\n    WHERE Won_Date < dates.as_of_date\n      AND Target_Won > 0\n    GROUP BY RecordType, OpportunityType, FunnelType, Region, Segment, Source, Won_Date\n    HAVING SUM(Actual_Won) < SUM(Target_Won)\n  ),\n\n  past_due_items AS (\n    SELECT * FROM past_due_under_pacing\n    QUALIFY ROW_NUMBER() OVER (ORDER BY acv_gap DESC) <= 15\n  ),\n\n  past_due_summary AS (\n    SELECT\n      COUNT(*) AS count,\n      SUM(acv_gap) AS total_acv_at_risk\n    FROM past_due_under_pacing\n  ),\n\n  -- Alert 2: Missed lead window\n  missed_lead_window AS (\n    SELECT\n      RecordType AS rt,\n      OpportunityType AS ot,\n      Region AS r,\n      Segment AS seg,\n      Source AS src,\n      TargetDate AS mql_date,\n      SUM(Target_MQL) AS t_mql,\n      SUM(Actual_MQL) AS a_mql,\n      SUM(COALESCE(MQL_Revenue_Slippage, 0)) AS mql_slip,\n      (SUM(Target_MQL) - SUM(Actual_MQL)) AS mql_gap\n    FROM `data-analytics-306119.Staging.StrategicOperatingPlan`\n    WHERE COALESCE(MQL_Pacing_Alert, '') = 'Missed Lead Window'\n    GROUP BY RecordType, OpportunityType, Region, Segment, Source, TargetDate\n  ),\n\n  missed_lead_items AS (\n    SELECT * FROM missed_lead_window\n    QUALIFY ROW_NUMBER() OVER (ORDER BY mql_date DESC) <= 15\n  ),\n\n  missed_lead_summary AS (\n    SELECT\n      COUNT(*) AS count,\n      SUM(ABS(mql_slip)) AS total_revenue_impact\n    FROM missed_lead_window\n  ),\n\n  -- Alert 3: Upcoming won risk (next 14 days)\n  upcoming_won_risk AS (\n    SELECT\n      RecordType AS rt,\n      OpportunityType AS ot,\n      FunnelType AS ft,\n      Region AS r,\n      Segment AS seg,\n      Source AS src,\n      Won_Date AS won_date,\n      SUM(Target_Won) AS t_won,\n      SUM(Actual_Won) AS a_won,\n      SUM(Target_ACV) AS t_acv,\n      SUM(Actual_ACV) AS a_acv,\n      (SUM(Target_ACV) - SUM(Actual_ACV)) AS acv_gap\n    FROM `data-analytics-306119.Staging.StrategicOperatingPlan`, dates\n    WHERE Won_Date BETWEEN dates.as_of_date AND dates.upcoming_risk_end\n    GROUP BY RecordType, OpportunityType, FunnelType, Region, Segment, Source, Won_Date\n    HAVING SUM(Target_Won) > SUM(Actual_Won)\n  ),\n\n  upcoming_risk_items AS (\n    SELECT * FROM upcoming_won_risk\n    QUALIFY ROW_NUMBER() OVER (ORDER BY acv_gap DESC) <= 15\n  ),\n\n  upcoming_risk_summary AS (\n    SELECT\n      COUNT(*) AS count,\n      SUM(acv_gap) AS total_acv_at_risk\n    FROM upcoming_won_risk\n  ),\n\n  -- Anomaly detection (MTD window)\n  anomaly_counts AS (\n    SELECT\n      COUNTIF(Actual_SAL > Actual_SQL) AS rows_sal_gt_sql,\n      COUNTIF(Actual_SQO > Actual_SAL) AS rows_sqo_gt_sal,\n      COUNTIF(Actual_Won > Actual_SQO) AS rows_won_gt_sqo\n    FROM `data-analytics-306119.Staging.StrategicOperatingPlan`, dates\n    WHERE TargetDate BETWEEN dates.mtd_start AND dates.as_of_date\n  )\n\n-- Build final JSON\nSELECT\n  TO_JSON_STRING(STRUCT(\n    CAST(CURRENT_TIMESTAMP() AS STRING) AS generated_at_utc,\n    d.as_of_date,\n    d.percentile,\n    d.week_starts_on,\n    basis.chosen_date_basis AS actuals_date_basis,\n\n    -- Top variance drivers\n    ARRAY(\n      SELECT AS STRUCT\n        rt, ot, ft, r, seg, src,\n        t_won, a_won, t_acv, a_acv, acv_var, won_slip\n      FROM top_variance_mtd\n      ORDER BY acv_var\n    ) AS top_variance_mtd,\n\n    -- Top positive variance\n    ARRAY(\n      SELECT AS STRUCT\n        rt, ot, ft, r, seg, src,\n        t_won, a_won, t_acv, a_acv, acv_var, won_slip\n      FROM top_positive_mtd\n      ORDER BY acv_var DESC\n    ) AS top_positive_mtd,\n\n    -- Top booked deals\n    ARRAY(\n      SELECT AS STRUCT\n        rt, ot, ft, r, seg, src,\n        t_won, a_won, t_acv, a_acv, acv_var, won_slip\n      FROM top_booked_mtd\n      ORDER BY a_acv DESC\n    ) AS top_booked_mtd,\n\n    -- Inbound MQL gaps\n    ARRAY(\n      SELECT AS STRUCT\n        r, seg, src, a_mql, t_mql, mql_gap, mql_attainment\n      FROM inbound_mql_wtd\n      ORDER BY mql_gap DESC\n    ) AS inbound_mql_wtd,\n\n    -- Alert details with $ sums\n    STRUCT(\n      -- Past due\n      (SELECT count FROM past_due_summary) AS past_due_under_pacing_count,\n      (SELECT total_acv_at_risk FROM past_due_summary) AS past_due_under_pacing_sum,\n      ARRAY(\n        SELECT AS STRUCT\n          rt, ot, ft, r, seg, src, won_date,\n          t_won, a_won, t_acv, a_acv, acv_var, acv_gap\n        FROM past_due_items\n        ORDER BY acv_gap DESC\n      ) AS past_due_under_pacing_items,\n\n      -- Missed lead window\n      (SELECT count FROM missed_lead_summary) AS missed_lead_window_count,\n      (SELECT total_revenue_impact FROM missed_lead_summary) AS missed_lead_window_sum,\n      ARRAY(\n        SELECT AS STRUCT\n          rt, ot, r, seg, src, mql_date,\n          t_mql, a_mql, mql_slip, mql_gap\n        FROM missed_lead_items\n        ORDER BY mql_date DESC\n      ) AS missed_lead_window_items,\n\n      -- Upcoming risk\n      (SELECT count FROM upcoming_risk_summary) AS upcoming_won_risk_next_14_days_count,\n      (SELECT total_acv_at_risk FROM upcoming_risk_summary) AS upcoming_won_risk_next_14_days_sum,\n      ARRAY(\n        SELECT AS STRUCT\n          rt, ot, ft, r, seg, src, won_date,\n          t_won, a_won, t_acv, a_acv, acv_gap\n        FROM upcoming_risk_items\n        ORDER BY acv_gap DESC\n      ) AS upcoming_won_risk_next_14_days_items\n    ) AS alerts,\n\n    -- Anomaly counts\n    (SELECT AS STRUCT\n      rows_sal_gt_sql,\n      rows_sqo_gt_sal,\n      rows_won_gt_sqo\n    FROM anomaly_counts) AS anomaly_counts\n\n  )) AS detail_payload_json\nFROM dates d\nCROSS JOIN actuals_date_basis_calc basis\n",
  "errors": []
}